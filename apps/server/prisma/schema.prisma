// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  ADMIN
  MODERATOR
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum MaterialType {
  PDF
  TEXT
  IMAGE
  DOCUMENT
}

enum QuizDifficulty {
  EASY
  MEDIUM
  HARD
}

enum BadgeType {
  STREAK
  QUIZ_MASTER
  EARLY_BIRD
  NIGHT_OWL
  STUDY_WARRIOR
  COURSE_COMPLETE
  RANK_UP
  DEPARTMENT_TOP
}

enum StudyRank {
  NOVICE
  LEARNER
  SCHOLAR
  EXPERT
  MASTER
  GRANDMASTER
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  username          String?        @unique
  firstName         String
  lastName          String
  password          String? // Nullable for OAuth users
  authProvider      AuthProvider   @default(LOCAL)
  googleId          String?        @unique
  role              Role           @default(STUDENT)
  
  // Profile
  avatar            String?
  bio               String?
  university        String? // University name
  department        String?
  faculty           String?
  level             String? // 100, 200, 300, 400, 500
  matricNumber      String?        @unique
  
  // Email verification
  isEmailVerified   Boolean        @default(false)
  emailVerificationToken String?
  emailVerificationExpiry DateTime?
  
  // Password reset
  passwordResetToken String?
  passwordResetExpiry DateTime?
  
  // Refresh token
  refreshToken      String?
  
  // Gamification
  points            Int            @default(0)
  currentStreak     Int            @default(0)
  longestStreak     Int            @default(0)
  lastStudyDate     DateTime?
  studyRank         StudyRank      @default(NOVICE)
  totalStudyTime    Int            @default(0) // in minutes
  
  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  courses           CourseEnrollment[]
  materials         Material[]
  quizAttempts      QuizAttempt[]
  badges            UserBadge[]
  achievements      UserAchievement[]
  studySessions     StudySession[]
  aiConversations   AIConversation[]
  groupMemberships  StudyGroupMember[]
  groupsCreated     StudyGroup[]   @relation("GroupCreator")
  
  @@index([email])
  @@index([department, faculty])
  @@index([points])
  @@map("users")
}

model Course {
  id                String         @id @default(cuid())
  code              String         @unique // e.g., "CSC301"
  title             String         // e.g., "Data Structures & Algorithms"
  description       String?
  department        String
  faculty           String
  level             String
  semester          String? // e.g., "First Semester"
  creditUnits       Int            @default(3)
  
  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  enrollments       CourseEnrollment[]
  materials         Material[]
  quizzes           Quiz[]
  weakTopics        WeakTopic[]
  
  @@index([code])
  @@index([department, faculty])
  @@map("courses")
}

model CourseEnrollment {
  id                String         @id @default(cuid())
  userId            String
  courseId          String
  
  // Progress tracking
  masteryPercentage Float          @default(0) // 0-100
  lastAccessedAt    DateTime?
  timeSpent         Int            @default(0) // in minutes
  
  // Timestamps
  enrolledAt        DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  course            Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("course_enrollments")
}

model Material {
  id                String         @id @default(cuid())
  title             String
  description       String?
  type              MaterialType
  fileUrl           String
  fileSize          Int // in bytes
  mimeType          String?
  
  // Content for AI processing
  extractedText     String?        @db.Text
  summary           String?        @db.Text
  
  // Organization
  courseId          String
  uploadedById      String
  tags              String[] // for categorization
  
  // Timestamps
  uploadedAt        DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  course            Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  uploadedBy        User           @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  aiConversations   AIConversation[]
  
  @@index([courseId])
  @@index([uploadedById])
  @@map("materials")
}

model WeakTopic {
  id                String         @id @default(cuid())
  topic             String
  courseId          String
  
  // Tracking
  incorrectCount    Int            @default(1)
  lastAttemptDate   DateTime       @default(now())
  
  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  course            Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([courseId, topic])
  @@index([courseId])
  @@map("weak_topics")
}

model Quiz {
  id                String         @id @default(cuid())
  title             String
  description       String?
  courseId          String
  difficulty        QuizDifficulty @default(MEDIUM)
  timeLimit         Int? // in minutes
  passingScore      Int            @default(70) // percentage
  
  // Auto-generated or manual
  isAutoGenerated   Boolean        @default(false)
  
  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  course            Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions         Question[]
  attempts          QuizAttempt[]
  
  @@index([courseId])
  @@map("quizzes")
}

model Question {
  id                String         @id @default(cuid())
  quizId            String
  question          String         @db.Text
  questionType      String         @default("multiple_choice") // multiple_choice, true_false, short_answer
  explanation       String?        @db.Text
  points            Int            @default(1)
  order             Int            @default(0)
  
  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  quiz              Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers           Answer[]
  
  @@index([quizId])
  @@map("questions")
}

model Answer {
  id                String         @id @default(cuid())
  questionId        String
  answerText        String         @db.Text
  isCorrect         Boolean        @default(false)
  order             Int            @default(0)
  
  // Timestamps
  createdAt         DateTime       @default(now())
  
  // Relations
  question          Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@index([questionId])
  @@map("answers")
}

model QuizAttempt {
  id                String         @id @default(cuid())
  userId            String
  quizId            String
  
  // Scoring
  score             Float // percentage
  pointsEarned      Int            @default(0)
  totalQuestions    Int
  correctAnswers    Int
  
  // Timing
  startedAt         DateTime       @default(now())
  completedAt       DateTime?
  timeSpent         Int? // in seconds
  
  // Data
  answers           Json // { questionId: answerId/answerText }
  
  // Relations
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz              Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

model AIConversation {
  id                String         @id @default(cuid())
  userId            String
  title             String         @default("New Conversation")
  
  // Context
  materialIds       String[] // Materials used for context
  courseContext     String?
  
  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  materials         Material[]
  messages          AIMessage[]
  
  @@index([userId])
  @@map("ai_conversations")
}

model AIMessage {
  id                String         @id @default(cuid())
  conversationId    String
  role              String // user | assistant
  content           String         @db.Text
  
  // Metadata
  tokensUsed        Int?
  model             String? // gemini-pro, gemini-pro-vision
  
  // Timestamps
  createdAt         DateTime       @default(now())
  
  // Relations
  conversation      AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@map("ai_messages")
}

model Badge {
  id                String         @id @default(cuid())
  name              String         @unique
  description       String
  type              BadgeType
  icon              String
  
  // Requirements
  requiredValue     Int? // e.g., 7 for 7-day streak
  
  // Timestamps
  createdAt         DateTime       @default(now())
  
  // Relations
  userBadges        UserBadge[]
  
  @@map("badges")
}

model UserBadge {
  id                String         @id @default(cuid())
  userId            String
  badgeId           String
  
  // Timestamps
  earnedAt          DateTime       @default(now())
  
  // Relations
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge             Badge          @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@index([userId])
  @@map("user_badges")
}

model Achievement {
  id                String         @id @default(cuid())
  title             String
  description       String
  icon              String
  points            Int            @default(0)
  
  // Requirements
  requirement       Json // Flexible requirements definition
  
  // Timestamps
  createdAt         DateTime       @default(now())
  
  // Relations
  userAchievements  UserAchievement[]
  
  @@map("achievements")
}

model UserAchievement {
  id                String         @id @default(cuid())
  userId            String
  achievementId     String
  
  // Progress
  progress          Int            @default(0) // 0-100
  isCompleted       Boolean        @default(false)
  
  // Timestamps
  unlockedAt        DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement       Achievement    @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model StudySession {
  id                String         @id @default(cuid())
  userId            String
  courseId          String?
  
  // Session data
  duration          Int // in minutes
  pointsEarned      Int            @default(0)
  activitiesCount   Int            @default(0)
  
  // Session type
  sessionType       String // study, quiz, ai_tutor, group
  
  // Timestamps
  startedAt         DateTime       @default(now())
  endedAt           DateTime?
  
  // Relations
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([startedAt])
  @@map("study_sessions")
}

model StudyGroup {
  id                String         @id @default(cuid())
  name              String
  description       String?
  courseCode        String? // Optional: link to specific course
  
  // Settings
  isPrivate         Boolean        @default(false)
  maxMembers        Int            @default(50)
  inviteCode        String?        @unique
  
  // Creator
  createdById       String
  
  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  creator           User           @relation("GroupCreator", fields: [createdById], references: [id], onDelete: Cascade)
  members           StudyGroupMember[]
  
  @@index([createdById])
  @@index([inviteCode])
  @@map("study_groups")
}

model StudyGroupMember {
  id                String         @id @default(cuid())
  groupId           String
  userId            String
  
  // Role in group
  isAdmin           Boolean        @default(false)
  
  // Timestamps
  joinedAt          DateTime       @default(now())
  
  // Relations
  group             StudyGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("study_group_members")
}
